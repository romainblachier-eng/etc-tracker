name: Daily ETC Update

# ──────────────────────────────────────────────────
# Déclencheurs
# ──────────────────────────────────────────────────
on:
  # Tous les jours à 9h00 heure de Paris (UTC+1) → 08:00 UTC
  schedule:
    - cron: '0 8 * * *'

  # Déclenchement manuel depuis l'onglet "Actions" de GitHub
  workflow_dispatch:

# ──────────────────────────────────────────────────
# Permissions
# ──────────────────────────────────────────────────
permissions:
  contents: write   # pour committer l'article dans main
  pages:    write   # pour déployer sur gh-pages

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest

    steps:

      # 1. Checkout du dépôt (avec tout l'historique)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Python
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3. Dépendances Python
      - name: Install Python dependencies
        run: pip install anthropic requests

      # 4. Génération de l'article du jour
      - name: Generate daily article
        env:
          ANTHROPIC_API_KEY:      ${{ secrets.ANTHROPIC_API_KEY }}
          BEEHIIV_API_KEY:        ${{ secrets.BEEHIIV_API_KEY }}
          BEEHIIV_PUBLICATION_ID: ${{ secrets.BEEHIIV_PUBLICATION_ID }}
        run: python scripts/generate_article.py

      # 5. Commit de l'article dans la branche main
      - name: Commit new article
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/posts/
          # Ne committe que s'il y a un changement
          git diff --staged --quiet || git commit -m "Article ETC — $(date +%Y-%m-%d)"
          git push

      # 6. Installation de Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: false

      # 7. Build du site
      - name: Build Hugo site
        run: hugo --minify

      # 8. Déploiement vers la branche gh-pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir:  ./public
          commit_message: "Deploy ETC Tracker — ${{ github.run_id }}"
